# docker-compose.override.yml
# Automatically loaded in development mode (docker-compose up)
# Provides hot reload and source code mounting

services:
  backend:
    build:
      target: development
    volumes:
      # Mount source code for hot reload (no root mount to avoid conflicts)
      - ./src:/app/src
      - ./backend:/app/backend
      - ./prompts:/app/prompts
      - ./scripts:/app/scripts
      - ./vector_db:/app/vector_db:ro
      - ./config.json:/app/config.json
      # Exclude Python cache from host (anonymous volumes)
      - /app/src/__pycache__
      - /app/backend/__pycache__
    command: >
      uvicorn backend.main:app
      --host 0.0.0.0
      --port 8000
      --reload
      --reload-dir /app/backend
      --reload-dir /app/src
      --log-level info
      --loop asyncio
    environment:
      # Development settings
      STORAGE_BACKEND: postgresql  # Use PostgreSQL in dev
      LOG_LEVEL: DEBUG
      AUTH_SECRET_KEY: ${AUTH_SECRET_KEY}

  frontend:
    build:
      target: development
    volumes:
      # Mount source for hot reload
      - ./frontend/src:/app/src
      - ./frontend/public:/app/public
      - ./frontend/index.html:/app/index.html
      - ./frontend/vite.config.ts:/app/vite.config.ts
      - ./frontend/tsconfig.json:/app/tsconfig.json
      - ./frontend/tsconfig.app.json:/app/tsconfig.app.json
      - ./frontend/tailwind.config.js:/app/tailwind.config.js
      # Prevent node_modules from being overridden by host
      - /app/node_modules
    command: npm run dev -- --host 0.0.0.0
    environment:
      # Empty = relative URLs, goes through Nginx proxy (same-origin)
      VITE_API_BASE_URL: ""

  postgres:
    # Enable verbose logging in development
    command: >
      postgres
      -c config_file=/etc/postgresql/postgresql.conf
      -c log_statement=all
      -c log_duration=on
      -c log_min_duration_statement=100
    ports:
      # DEVELOPMENT ONLY: Expose PostgreSQL for direct connection (pgAdmin, DBeaver)
      # WARNING: This port mapping is REMOVED in production (docker-compose.yml)
      # Never expose database ports in production deployments
      - "${POSTGRES_PORT:-5432}:5432"
