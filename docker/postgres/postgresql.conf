# PostgreSQL 16 Configuration for SUJBOT2
# Optimized for vector search workloads with pgvector
# Target: 16GB RAM system with SSD storage

# ============================================================================
# CONNECTIONS AND AUTHENTICATION
# ============================================================================
# Listen on all interfaces (required for Docker networking)
listen_addresses = '*'

max_connections = 200
superuser_reserved_connections = 3

# ============================================================================
# MEMORY SETTINGS
# ============================================================================
# shared_buffers: 25% of total RAM for dedicated PostgreSQL server
shared_buffers = 4GB

# effective_cache_size: 50-75% of total RAM (OS + PostgreSQL cache)
effective_cache_size = 12GB

# work_mem: Memory for sort/hash operations per query
# Formula: (Total RAM - shared_buffers) / (max_connections / 2)
# (16GB - 4GB) / (200 / 2) = 120MB, but we set conservative 64MB
work_mem = 64MB

# maintenance_work_mem: Memory for VACUUM, CREATE INDEX, etc.
# Important for building pgvector HNSW indexes (can take hours!)
maintenance_work_mem = 1GB

# ============================================================================
# QUERY PLANNER
# ============================================================================
# random_page_cost: 1.1 for SSD (default 4.0 is for HDD)
random_page_cost = 1.1

# effective_io_concurrency: Number of simultaneous I/O operations (SSD)
effective_io_concurrency = 200

# ============================================================================
# WRITE AHEAD LOG (WAL)
# ============================================================================
wal_buffers = 16MB
wal_compression = on
checkpoint_completion_target = 0.9
max_wal_size = 4GB
min_wal_size = 1GB

# ============================================================================
# PARALLEL QUERY EXECUTION
# ============================================================================
max_worker_processes = 8
max_parallel_workers_per_gather = 4
max_parallel_workers = 8
max_parallel_maintenance_workers = 4

# ============================================================================
# AUTOVACUUM (Automatic cleanup)
# ============================================================================
autovacuum = on
autovacuum_max_workers = 4
autovacuum_naptime = 1min
autovacuum_vacuum_threshold = 50
autovacuum_vacuum_scale_factor = 0.1
autovacuum_analyze_threshold = 50
autovacuum_analyze_scale_factor = 0.05

# ============================================================================
# LOGGING
# ============================================================================
# Log slow queries (development: log all, production: log > 1s)
log_min_duration_statement = 1000  # milliseconds

# Log connections and disconnections
log_connections = off
log_disconnections = off

# Log statement type
log_statement = 'none'  # 'none', 'ddl', 'mod', 'all'

# Log line format
log_line_prefix = '%t [%p]: [%l-1] user=%u,db=%d,app=%a,client=%h '

# Log destination
logging_collector = on
log_directory = 'log'
log_filename = 'postgresql-%Y-%m-%d_%H%M%S.log'
log_rotation_age = 1d
log_rotation_size = 100MB
log_truncate_on_rotation = on

# ============================================================================
# EXTENSIONS (preload)
# ============================================================================
shared_preload_libraries = 'pg_stat_statements'

# pg_stat_statements: Track query execution statistics
pg_stat_statements.max = 10000
pg_stat_statements.track = all

# ============================================================================
# LOCALE AND FORMATTING
# ============================================================================
lc_messages = 'en_US.UTF-8'
lc_monetary = 'en_US.UTF-8'
lc_numeric = 'en_US.UTF-8'
lc_time = 'en_US.UTF-8'
default_text_search_config = 'pg_catalog.english'

# ============================================================================
# CLIENT CONNECTION DEFAULTS
# ============================================================================
timezone = 'UTC'
datestyle = 'iso, mdy'
default_tablespace = ''
temp_tablespaces = ''

# ============================================================================
# PGVECTOR SPECIFIC SETTINGS
# ============================================================================
# These can be overridden per session with SET commands

# HNSW index settings (set during CREATE INDEX)
# - Not configurable here, but documented for reference
# - hnsw.ef_construction: Build quality (64-128 recommended)
# - hnsw.m: Connections per layer (16-32 recommended)

# HNSW search settings (set per query)
# SET hnsw.ef_search = 40;  # 40-100 for good recall (higher = slower but more accurate)

# IVFFlat search settings (set per query)
# SET ivfflat.probes = 10;  # 10-20% of lists parameter

# ============================================================================
# SECURITY
# ============================================================================
# SSL (uncomment for production)
# ssl = on
# ssl_cert_file = '/etc/ssl/certs/server.crt'
# ssl_key_file = '/etc/ssl/private/server.key'

# Password encryption
password_encryption = scram-sha-256
